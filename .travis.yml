sudo: required
dist: trusty
language: ruby

before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: FgWmF9F0lUo3U4OH+GzFowt9L3ROFxlhk/BeRDoVunVAuS4+Wm9Y0wtn5sMBVaYv4p5hu3xnKE/jSKThgmOKpO/h4kaXsFTzIhzDHvp4DDfsCz1S34ZOEdOU12YjssTN6I+Erq64eil8Sw/p/T26RvHUlMp/fqgFVJkJWDCaoWVWVV7m/4AIDAcGy5PalVJqiOpi/KtwAZAajwOj9nwZpoefeMl4i5+bqwS8s0mgAnWJDukNtQxBDefigMBCWDFRGuUXgu0nclexihTB+aHZATbFxsmVNbyNg47JYjVsYwtYPMIRaMFN2pTqdR6oPg0oJNUzDXAfLulrUCIwKp7Imeiaxe6RpIq5gmSttSRx8+Bx2xcZ5BWJRmAOz61bU0MCAJPi9Gz6H8D5xhWV5//qtLWQwKmRhX6lDfU0UbGP7aJIiULZpFBkyvGVvC5eTv3aCt5SXvaixYaQSXGuK5z9qBNIQcv+FTGlrpsrtguiSnzqwjndnvvAyfat43lAc+hG7Us0JP8yAJVS344imnl7dIfiC8CPVrDAD5CynKZN7eMxIvr6J1cqewwfvdEzzwS6HuzPwPS/8UkzzGkAWs3YjvwXuyDmyXjUOZtOmPwtbJwoz6YOcxG22HuPWbU2Eb2EoFKd+U1UDg4elXWo0k4RVhahU6rXVyaxz0iISfJqIHI=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  on:
    repo: GITenberg/Katherine-s-Sheaves_5008
    tags: true
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy